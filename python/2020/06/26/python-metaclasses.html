<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Deciphering Python’s Metaclasses | Red’s Digressions</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Deciphering Python’s Metaclasses" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Unraveling the voodoo magic behind Python’s metaclasses" />
<meta property="og:description" content="Unraveling the voodoo magic behind Python’s metaclasses" />
<link rel="canonical" href="https://rednafi.github.io/digressions/python/2020/06/26/python-metaclasses.html" />
<meta property="og:url" content="https://rednafi.github.io/digressions/python/2020/06/26/python-metaclasses.html" />
<meta property="og:site_name" content="Red’s Digressions" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-26T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2020-06-26T00:00:00-05:00","headline":"Deciphering Python’s Metaclasses","description":"Unraveling the voodoo magic behind Python’s metaclasses","mainEntityOfPage":{"@type":"WebPage","@id":"https://rednafi.github.io/digressions/python/2020/06/26/python-metaclasses.html"},"@type":"BlogPosting","url":"https://rednafi.github.io/digressions/python/2020/06/26/python-metaclasses.html","dateModified":"2020-06-26T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/digressions/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://rednafi.github.io/digressions/feed.xml" title="Red's Digressions" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-160409032-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/digressions/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Deciphering Python’s Metaclasses | Red’s Digressions</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Deciphering Python’s Metaclasses" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Unraveling the voodoo magic behind Python’s metaclasses" />
<meta property="og:description" content="Unraveling the voodoo magic behind Python’s metaclasses" />
<link rel="canonical" href="https://rednafi.github.io/digressions/python/2020/06/26/python-metaclasses.html" />
<meta property="og:url" content="https://rednafi.github.io/digressions/python/2020/06/26/python-metaclasses.html" />
<meta property="og:site_name" content="Red’s Digressions" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-26T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2020-06-26T00:00:00-05:00","headline":"Deciphering Python’s Metaclasses","description":"Unraveling the voodoo magic behind Python’s metaclasses","mainEntityOfPage":{"@type":"WebPage","@id":"https://rednafi.github.io/digressions/python/2020/06/26/python-metaclasses.html"},"@type":"BlogPosting","url":"https://rednafi.github.io/digressions/python/2020/06/26/python-metaclasses.html","dateModified":"2020-06-26T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://rednafi.github.io/digressions/feed.xml" title="Red's Digressions" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-160409032-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/digressions/">Red&#39;s Digressions</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/digressions/about/">About Me</a><a class="page-link" href="/digressions/search/">Search</a><a class="page-link" href="/digressions/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Deciphering Python&#39;s Metaclasses
    </h1><p class="page-description">Unraveling the voodoo magic behind Python&#39;s metaclasses</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-06-26T00:00:00-05:00"
        itemprop="datePublished">
        Jun 26, 2020
      </time>
      • <span class="read-time" title="Estimated read time">
    
    
      22 min read
    
</span></p>

    
    <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i>
      
      <a class="category-tags-link"
        href="/digressions/categories/#Python">Python</a>
      
      
    </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#metaclasses">Metaclasses</a></li>
<li class="toc-entry toc-h2"><a href="#understanding-type-and-class">Understanding Type and Class</a></li>
<li class="toc-entry toc-h2"><a href="#special-methods-used-by-metaclasses">Special Methods Used by Metaclasses</a></li>
<li class="toc-entry toc-h2"><a href="#metaclass-conflicts">Metaclass Conflicts</a></li>
<li class="toc-entry toc-h2"><a href="#examples-in-the-wild">Examples in the Wild</a>
<ul>
<li class="toc-entry toc-h3"><a href="#simple-logging-with-metaclasses">Simple Logging with Metaclasses</a></li>
<li class="toc-entry toc-h3"><a href="#returning-class-attributes-in-a-custom-list">Returning Class Attributes in a Custom List</a></li>
<li class="toc-entry toc-h3"><a href="#creating-singleton-class">Creating Singleton Class</a></li>
<li class="toc-entry toc-h3"><a href="#implementing-a-class-that-cant-be-subclassed">Implementing a Class that Can’t be Subclassed</a></li>
<li class="toc-entry toc-h3"><a href="#disallowing-multiple-inheritance">Disallowing Multiple Inheritance</a></li>
<li class="toc-entry toc-h3"><a href="#timing-classes-with-metaclasses">Timing Classes with Metaclasses</a></li>
<li class="toc-entry toc-h3"><a href="#registering-plugins-with-metaclasses">Registering Plugins With Metaclasses</a></li>
<li class="toc-entry toc-h3"><a href="#debugging-methods-with-metaclasses">Debugging Methods with Metaclasses</a></li>
<li class="toc-entry toc-h3"><a href="#exception-handling-with-metaclasses">Exception Handling with Metaclasses</a></li>
<li class="toc-entry toc-h3"><a href="#abstract-base-classes">Abstract Base Classes</a></li>
<li class="toc-entry toc-h3"><a href="#metaclasses--dataclasses">Metaclasses &amp; Dataclasses</a>
<ul>
<li class="toc-entry toc-h4"><a href="#creating-multiple-dataclasses">Creating Multiple DataClasses</a></li>
<li class="toc-entry toc-h4"><a href="#avoiding-dataclass-decorator-with-metaclasses">Avoiding Dataclass Decorator with Metaclasses</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#should-you-use-it">Should You Use It?</a></li>
<li class="toc-entry toc-h2"><a href="#remarks">Remarks</a></li>
<li class="toc-entry toc-h2"><a href="#references">References</a></li>
</ul><p>In Python, metaclass is one of the few tools that enables you to inject metaprogramming capabilities into your code. The term metaprogramming refers to the potential for a program to manipulate itself in a self referential manner. However, messing with metaclasses is often considered an arcane art that is beyond the grasp of the proletariats. Heck, even <a href="https://en.wikipedia.org/wiki/Tim_Peters_(software_engineer)">Tim Peters</a> advices you to tread carefully while dealing with these.</p>

<blockquote>
  <p>Metaclasses are deeper magic than 99% of users should ever worry about. If you wonder whether you need them, you don’t (the people who actually need them know with certainty that they need them, and don’t need an explanation about why).</p>
</blockquote>

<p>Metaclasses are an esoteric OOP concept, lurking behind virtually all Python code. Every Python class that you create is attached to a default metaclass and Python cleverly abstracts away all the meta-magics. So, you’re indirectly using them all the time whether you are aware of it or not. For the most part, you don’t need to be aware of it. Most Python programmers rarely, if ever, have to think about metaclasses. This makes metaclasses exciting for me and I want to explore them in this post to formulate my own judgement. Let’s dive in.</p>

<h2 id="metaclasses">
<a class="anchor" href="#metaclasses" aria-hidden="true"><span class="octicon octicon-link"></span></a>Metaclasses</h2>

<p>A metaclass is a class whose instances are classes. Like an “ordinary” class defines the behavior of the instances of the class, a metaclass defines the behavior of classes and their instances.</p>

<p><img src="https://media.geeksforgeeks.org/wp-content/uploads/metaclass-hierarchy-Page-1-1024x370.jpeg" alt="image.png"></p>

<p>Metaclasses are not supported by every object oriented programming language. Those programming language, which support metaclasses, considerably vary in way they implement them. Python provides you a way to get under the hood and define custom metaclasses.</p>

<h2 id="understanding-type-and-class">
<a class="anchor" href="#understanding-type-and-class" aria-hidden="true"><span class="octicon octicon-link"></span></a>Understanding Type and Class</h2>

<p>In Python, everything is an object. Classes are objects as well. As a result all classes must have corresponding types. You deal with built in types like <code class="highlighter-rouge">int</code>, <code class="highlighter-rouge">float</code>, <code class="highlighter-rouge">list</code> etc all the time. Consider this example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'int'&gt;
&lt;class 'type'&gt;
</code></pre></div></div>

<p>In the above example, variable <code class="highlighter-rouge">a</code> is an instance of the built in class <code class="highlighter-rouge">int</code>. Type of <code class="highlighter-rouge">a</code> is <code class="highlighter-rouge">int</code> and the type of <code class="highlighter-rouge">int</code> is <code class="highlighter-rouge">type</code>. User defined classes also show similar behavior. For example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="n">a</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Foo</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class '__main__.Foo'&gt;
&lt;class 'type'&gt;
</code></pre></div></div>

<p>Here, I’ve defined another class named <code class="highlighter-rouge">Foo</code> and created an instance <code class="highlighter-rouge">a</code> of the class. Applying <code class="highlighter-rouge">type</code> on instance <code class="highlighter-rouge">a</code> reveals its type as <code class="highlighter-rouge">__main__.Foo</code> and applying <code class="highlighter-rouge">type</code> on class <code class="highlighter-rouge">Foo</code> reveals the type as <code class="highlighter-rouge">type</code>. So here, we can use the term <code class="highlighter-rouge">class</code> and <code class="highlighter-rouge">type</code> interchangeably. This brings up the question:</p>

<blockquote>
  <p>What on earth this <code class="highlighter-rouge">type</code> (function? class?) thing actually is and what is the type of <code class="highlighter-rouge">type</code>?</p>
</blockquote>

<p>Let’s apply <code class="highlighter-rouge">type</code> on <code class="highlighter-rouge">type</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">type</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'type'&gt;
</code></pre></div></div>

<p>Whaaaat? The type of any class (not instance of a class) in Python is <code class="highlighter-rouge">type</code> and the type of <code class="highlighter-rouge">type</code> is also <code class="highlighter-rouge">type</code>. By now, you’ve probably guessed that <code class="highlighter-rouge">type</code> is a very special class in Python that can reveal the type of itself and of any other class or object. In fact, <code class="highlighter-rouge">type</code> is a metaclass and all the classes in Python are instances of it. You can inspect that easily:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">Foo</span><span class="p">,</span> <span class="nb">type</span><span class="p">]:</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">klass</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'type'&gt;
&lt;class 'type'&gt;
&lt;class 'type'&gt;
&lt;class 'type'&gt;
&lt;class 'type'&gt;
&lt;class 'type'&gt;
True
True
</code></pre></div></div>

<p>The the last line of the above code snippet demonstrates that <code class="highlighter-rouge">type</code> is also an instance of metaclass <code class="highlighter-rouge">type</code>. Normally you can’t write self referential classes like that in pure Python. However, you can circumvent this limitation by subclassing from <code class="highlighter-rouge">type</code>. This enables you to write custom metaclasses that you can use to dictate and mutate the way classes are created and instantiated. From now on, I’ll be referring to the instance class of a metaclass as target class. Let’s create a custom metaclass that just prints the name of the target class while creating it:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PrintMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="s">"""__new__ gets executed before the target is created.

        Parameters
        ----------
        name : str
            name of the class being defined (Point in this example)
        bases : tuple
            base classes for constructed class, empty tuple in this case
        attrs : dict
            dict containing methods and fields defined in the class

        Returns
        -------
            instance class of this metaclass
        """</span>

        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Name of this class is: {name}"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">PrintMeta</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Name of this class is A
</code></pre></div></div>

<p>Despite the fact that we haven’t called class <code class="highlighter-rouge">A</code> or created an instance of it, the <code class="highlighter-rouge">__new__</code> method of metaclass <code class="highlighter-rouge">PrintMeta</code> got executed and printed the name of the target class. In the return statement of <code class="highlighter-rouge">__new__</code> method, <code class="highlighter-rouge">super()</code> was used to call the <code class="highlighter-rouge">__new__</code> method of the base class (<code class="highlighter-rouge">type</code>) of the metaclass <code class="highlighter-rouge">PrintMeta</code>.</p>

<h2 id="special-methods-used-by-metaclasses">
<a class="anchor" href="#special-methods-used-by-metaclasses" aria-hidden="true"><span class="octicon octicon-link"></span></a>Special Methods Used by Metaclasses</h2>

<p>Type <code class="highlighter-rouge">type</code>, as the default metaclass in Python, defines a few special methods that new metaclasses can override to implement unique code generation behavior. Here is a brief overview of these “magic” methods that exist on a metaclass:</p>

<ul>
  <li>
<code class="highlighter-rouge">__new__</code>: This method is called on the Metaclass before an instance of a class based on the metaclass is created</li>
  <li>
<code class="highlighter-rouge">__init__</code>: This method is called to set up values after the instance/object is created</li>
  <li>
<code class="highlighter-rouge">__prepare__</code>: Defines the class namespace in a mapping that stores the attributes</li>
  <li>
<code class="highlighter-rouge">__call__</code>: This method is called when the constructor of the new class is to be used to create an object</li>
</ul>

<p>These are the methods to override in your custom metaclass to give your classes behaviors different from that of <code class="highlighter-rouge">type</code>. The following example shows the default behaviors of these special methods and their execution order.</p>

<blockquote>
  <p>Some people immediately think of <code class="highlighter-rouge">__init__</code>, and I’ve occasionally called it “the constructor” myself; but in actuality, as its name indicates, it’s an initializer and by the time it’s invoked, the object has already been created, seeing as it’s passed in as self. The real constructor is a far less famous function: <code class="highlighter-rouge">__new__</code>. The reason you might never hear about it or use it- is that allocation doesn’t mean that much in Python, which manages memory on its own. So if you do override <code class="highlighter-rouge">__new__</code>, it’d be just like your <code class="highlighter-rouge">__init__</code> —except you’ll have to call into Python to actually create the object, and then return that object afterward.</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ExampleMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="s">"""Simple metaclass showing the execution flow of the
    special methods."""</span>

    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">__prepare__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">):</span>
        <span class="s">"""Defines the class namespace in a mapping that stores
        the attributes

        Parameters
        ----------
        name : str
            name of the class being defined (Point in this example)
        bases : tuple
            base classes for constructed class, empty tuple in this case
        """</span>

        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Calling __prepare__ method of {super()}!"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__prepare__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="s">"""__new__ is a classmethod, even without @classmethod decorator

        Parameters
        ----------
        name : str
            name of the class being defined (Point in this example)
        bases : tuple
            base classes for constructed class, empty tuple in this case
        attrs : dict
            dict containing methods and fields defined in the class
        """</span>

        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Calling __new__ method of {super()}!"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="s">"""This method is called to set up values after the
        instance/object is created."""</span>

        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Calling __init__ method of {super()}!"</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s">"""This method is called when the constructor of the new class
        is to be used to create an object

        Parameters
        ----------
        args : tuple
            position only arguments of the new class
        kwargs : dict
            keyward only arguments of the new class

        """</span>

        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Calling __call__ method of {super()}!"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Printing {self} args:"</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Printing {self} kwargs"</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ExampleMeta</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Calling __init__ method of {self}"</span><span class="p">)</span>


<span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Calling __prepare__ method of &lt;super: &lt;class 'ExampleMeta'&gt;, &lt;ExampleMeta object&gt;&gt;!
Calling __new__ method of &lt;super: &lt;class 'ExampleMeta'&gt;, &lt;ExampleMeta object&gt;&gt;!
Calling __init__ method of &lt;super: &lt;class 'ExampleMeta'&gt;, &lt;ExampleMeta object&gt;&gt;!
Calling __call__ method of &lt;super: &lt;class 'ExampleMeta'&gt;, &lt;ExampleMeta object&gt;&gt;!
Printing &lt;class '__main__.A'&gt; args: (1, 3)
Printing &lt;class '__main__.A'&gt; kwargs {}
Calling __init__ method of &lt;__main__.A object at 0x7febe710a130&gt;
</code></pre></div></div>

<p>Pay attention to the execution order of the special methods of the custom metaclass <code class="highlighter-rouge">ExampleMeta</code>. The <code class="highlighter-rouge">__prepare__</code> method is called first and is followed by <code class="highlighter-rouge">__new__</code>, <code class="highlighter-rouge">__init__</code> and <code class="highlighter-rouge">__call__</code> respectively. Only after that the first method <code class="highlighter-rouge">__init__</code> of the target class <code class="highlighter-rouge">A</code> is called. This is important since it’ll help you to decide how you’ll mutate and change the behavior of your target class.</p>

<h2 id="metaclass-conflicts">
<a class="anchor" href="#metaclass-conflicts" aria-hidden="true"><span class="octicon octicon-link"></span></a>Metaclass Conflicts</h2>

<p>Note that the metaclass argument is singular – you can’t attach more than one metaclass to a class. However, through multiple inheritance you can accidentally end up with more than one metaclass, and this produces a conflict which must be resolved.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FirstMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">SecondMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">First</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">FirstMeta</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Second</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">SecondMeta</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Third</span><span class="p">(</span><span class="n">First</span><span class="p">,</span> <span class="n">Second</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">third</span> <span class="o">=</span> <span class="n">Third</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

TypeError                                 Traceback (most recent call last)

&lt;ipython-input-340-6afe6bc8f8bc&gt; in &lt;module&gt;
        11     pass
        12
---&gt; 13 class Third(First, Second):
        14     pass
        15


TypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases
</code></pre></div></div>

<p>Class <code class="highlighter-rouge">First</code> and <code class="highlighter-rouge">Second</code> are attached to different metaclasses and class <code class="highlighter-rouge">Third</code> inherits from both of them. Since metaclasses trickle down to subclasses, class <code class="highlighter-rouge">Third</code> is now effective attached to two metaclasses (<code class="highlighter-rouge">FirstMeta</code> and <code class="highlighter-rouge">SecondMeta</code>). This will raise <code class="highlighter-rouge">TypeError</code>. Attachment with only one metaclass is allowed here.</p>

<h2 id="examples-in-the-wild">
<a class="anchor" href="#examples-in-the-wild" aria-hidden="true"><span class="octicon octicon-link"></span></a>Examples in the Wild</h2>

<p>In this section, I’ll go through a few real life examples where metaclasses can provide viable solutions to several tricky problems that you might encounter during software development. The solutions might appear over-engineered in some cases and almost all of them can be solved without using metaclasses. However, the purpose is to peek into the inner wirings of metaclasses and see how they can offer alternative solutions.</p>

<h3 id="simple-logging-with-metaclasses">
<a class="anchor" href="#simple-logging-with-metaclasses" aria-hidden="true"><span class="octicon octicon-link"></span></a>Simple Logging with Metaclasses</h3>

<p>The goal here is to log a few basic information about a class without directly adding any logging statements to it. Instead, you can whip up a custom metaclass to perform some metaprogramming and add those statements to the target class without mutating it explicitly.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LittleMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">"classname: {name}"</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">"baseclasses: {bases}"</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s">"attrs: {attrs}"</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">LittleMeta</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="s">"Point({self.x}, {self.y})"</span>


<span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO:root:classname: Point
INFO:root:baseclasses: ()
INFO:root:attrs: {'__module__': '__main__', '__qualname__': 'Point', '__init__': &lt;function Point.__init__ at 0x7f436c2db790&gt;, '__repr__': &lt;function Point.__repr__ at 0x7f436c2db4c0&gt;}


Point(5, 10)
</code></pre></div></div>

<p>In the above example, I’ve created a metaclass called <code class="highlighter-rouge">LittleMeta</code> and added the necessary logging statements to record the information about the target class. Since the logging statements are residing in the <code class="highlighter-rouge">__new__</code> method of the metaclass, these information will be logged before the creation of the target class. In the target class <code class="highlighter-rouge">Point</code>, <code class="highlighter-rouge">LittleMeta</code> replaces the default <code class="highlighter-rouge">type</code> metaclass and produces the desired result by mutating the class.</p>

<h3 id="returning-class-attributes-in-a-custom-list">
<a class="anchor" href="#returning-class-attributes-in-a-custom-list" aria-hidden="true"><span class="octicon octicon-link"></span></a>Returning Class Attributes in a Custom List</h3>

<p>In this case, I want to dynamically attach a new attribute to the target class called <code class="highlighter-rouge">__attrs_ordered__</code>. Accessing this attribute from the target class (or instance) will give out an alphabetically sorted list of the attribute names. Here, the <code class="highlighter-rouge">__prepare__</code> method inside the metaclass <code class="highlighter-rouge">AttrsListMeta</code> returns an <code class="highlighter-rouge">OrderDict</code> instead of a simple <code class="highlighter-rouge">dict</code> - so all attributes gathered before the <code class="highlighter-rouge">__new__</code> method call will be ordered. Just like the previous example, here, the <code class="highlighter-rouge">__new__</code> method inside the metaclass implements the logic required to get the sorted list of the attribute names.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>


<span class="k">class</span> <span class="nc">AttrsListMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">__prepare__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">attrs_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">attrs_names_ordered</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">attrs_names</span><span class="p">)</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s">"__attrs_ordered__"</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs_names_ordered</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">AttrsListMeta</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>


<span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">__attrs_ordered__</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>['__init__', '__module__', '__qualname__']
</code></pre></div></div>

<p>You can access the <code class="highlighter-rouge">__attrs_ordered__</code> attribute from both class <code class="highlighter-rouge">A</code> and an instance of class <code class="highlighter-rouge">A</code>. Try removing the <code class="highlighter-rouge">sorted()</code> function inside the <code class="highlighter-rouge">__new__</code> method of the metaclass and see what happens!</p>

<h3 id="creating-singleton-class">
<a class="anchor" href="#creating-singleton-class" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating Singleton Class</h3>

<p>In OOP term, a singleton class is a class that can have only one object (an instance of the class) at a time.</p>

<p>After the first time, if you try to instantiate a Singleton class, it will basically return the same instance of the class that was created before. So any modifications done to this apparently new instance will mutate the original instance since they’re basically the same instance.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Singleton</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="n">_instance</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_instance</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_instance</span><span class="p">[</span><span class="n">cls</span><span class="p">]</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_instance</span><span class="p">[</span><span class="n">cls</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">Singleton</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>

<span class="n">a</span> <span class="ow">is</span> <span class="n">b</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>True
</code></pre></div></div>

<p>In the above example, at first, I’ve created a singleton class <code class="highlighter-rouge">A</code> by attaching the <code class="highlighter-rouge">Singleton</code> metaclass to it. Secondly, I’ve instantiated class <code class="highlighter-rouge">A</code> and assigned the instance of the class to a variable <code class="highlighter-rouge">a</code>. Thirdly, I’ve instantiated the class again and assigned variable a <code class="highlighter-rouge">b</code> to this seemingly new instance. Checking the identity of the two variables <code class="highlighter-rouge">a</code> and <code class="highlighter-rouge">b</code> reveals that both of them actually point to the same instance.</p>

<h3 id="implementing-a-class-that-cant-be-subclassed">
<a class="anchor" href="#implementing-a-class-that-cant-be-subclassed" aria-hidden="true"><span class="octicon octicon-link"></span></a>Implementing a Class that Can’t be Subclassed</h3>

<p>Suppose you want to create a base class where the users of your class won’t be able to create any subclasses from the base class. In that case, you can write a metaclass and attach that your base class. The base class will raise <code class="highlighter-rouge">RuntimeError</code> if someone tries to create a subclass from it.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TerminateMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">type_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">type_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="n">cls</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span>
                    <span class="n">f</span><span class="s">"Subclassing a class that has "</span>
                    <span class="o">+</span> <span class="n">f</span><span class="s">"{cls.__name__} metaclass is prohibited"</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">TerminateMeta</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

RuntimeError                              Traceback (most recent call last)

&lt;ipython-input-438-ccba42f1f95b&gt; in &lt;module&gt;
        20
        21
---&gt; 22 class B(A):
        23     pass
        24

...

RuntimeError: Subclassing a class that has TerminateMeta metaclass is prohibited
</code></pre></div></div>

<h3 id="disallowing-multiple-inheritance">
<a class="anchor" href="#disallowing-multiple-inheritance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Disallowing Multiple Inheritance</h3>

<p>Multiple inheritance can be fragile and error prone. So, if you don’t want to allow the users to use a base class with any other base classes to form multiple inheritance, you can do so by attaching a metaclass to that target base class.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">NoMultiMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">TypeError</span><span class="p">(</span><span class="s">"Inherited multiple base classes!"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">NoMultiMeta</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># no error is raised
</span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># no error is raised
</span><span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># This will raise an error!
</span><span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

TypeError                                 Traceback (most recent call last)

&lt;ipython-input-404-36c323db1ea0&gt; in &lt;module&gt;
        18
        19 # This will raise an error!
---&gt; 20 class C(A, B):
        21     pass

...

TypeError: Inherited multiple base classes!
</code></pre></div></div>

<h3 id="timing-classes-with-metaclasses">
<a class="anchor" href="#timing-classes-with-metaclasses" aria-hidden="true"><span class="octicon octicon-link"></span></a>Timing Classes with Metaclasses</h3>

<p>Suppose you want to measure the execution time of different methods of a class. One way of doing that is to define a timer decorator and decorating all the methods to measure and show the execution time. However, by using a metaclass, you can avoid decorating the methods in the class individually and the metaclass will dynamically apply the timer decorator to all of the methods of your target class. This can reduce code repetition and improve code readability.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">FunctionType</span><span class="p">,</span> <span class="n">MethodType</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>


<span class="k">def</span> <span class="nf">timefunc</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="o">@</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">run_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Executing {func.__qualname__} took {run_time} seconds."</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">class</span> <span class="nc">TimerMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="c1"># key is attribute name and val is attribute value in attribute dict
</span>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">MethodType</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">new_cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">timefunc</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_cls</span>


<span class="k">class</span> <span class="nc">Shouter</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">TimerMeta</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">intro</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"I shout!"</span><span class="p">)</span>


<span class="n">s</span> <span class="o">=</span> <span class="n">Shouter</span><span class="p">()</span>
<span class="n">s</span><span class="o">.</span><span class="n">intro</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Executing Shouter.__init__ took 1.1920928955078125e-06 seconds.
I shout!
Executing Shouter.intro took 6.747245788574219e-05 seconds.
</code></pre></div></div>

<h3 id="registering-plugins-with-metaclasses">
<a class="anchor" href="#registering-plugins-with-metaclasses" aria-hidden="true"><span class="octicon octicon-link"></span></a>Registering Plugins With Metaclasses</h3>

<p>Suppose a specific single class represents a plugin in your code. You can write a metaclass to keep track of all of the plugins so than you don’t have to count them manually.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">registry</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">class</span> <span class="nc">RegisterMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="n">registry</span><span class="p">[</span><span class="n">new_cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cls</span>
        <span class="k">return</span> <span class="n">new_cls</span>


<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">RegisterMeta</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">D</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">b</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="n">registry</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'A': __main__.A, 'B': __main__.B, 'C': __main__.C, 'D': __main__.D}
</code></pre></div></div>

<h3 id="debugging-methods-with-metaclasses">
<a class="anchor" href="#debugging-methods-with-metaclasses" aria-hidden="true"><span class="octicon octicon-link"></span></a>Debugging Methods with Metaclasses</h3>

<p>Debugging a class often involves inspecting the individual methods and adding extra debugging logic to those. However, this can get tedious if you’ve do this over an over again. Instead you can write an inspection decorator and use a metaclass to dynamically apply the decorator to all of the methods of your target class. Later on, you can simply detach the metaclass once you’re done with debugging and don’t want the extra logic in your target class.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">FunctionType</span><span class="p">,</span> <span class="n">MethodType</span>


<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="s">"""Decorator for debugging passed function."""</span>

    <span class="o">@</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Full name of this method:"</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">__qualname__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">class</span> <span class="nc">DebugMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="c1"># key is attribute name and val is attribute value in attribute dict
</span>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">MethodType</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">new_cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">debug</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_cls</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">DebugMeta</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Calc</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<span class="k">class</span> <span class="nc">CalcAdv</span><span class="p">(</span><span class="n">Calc</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">mul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>


<span class="n">mycal</span> <span class="o">=</span> <span class="n">CalcAdv</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">mycal</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Full name of this method: CalcAdv.mul
6
</code></pre></div></div>

<h3 id="exception-handling-with-metaclasses">
<a class="anchor" href="#exception-handling-with-metaclasses" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exception Handling with Metaclasses</h3>

<p>Sometimes you need to handle exceptions in multiple methods of a class in a generic manner. That means all the methods of the class have the same exception handling, logging logic etc. Metaclasses can help you avoid adding repetitive exception handling and logging logics to your methods.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>


<span class="k">def</span> <span class="nf">exc_handler</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="s">"""Decorator for custom exception handling."""</span>

    <span class="o">@</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Exception Occured!"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Method name: {func.__qualname__}"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Args: {args}, Kwargs: {kwargs}"</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">class</span> <span class="nc">ExceptionMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="c1"># key is attribute name and val is attribute value in attribute dict
</span>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">MethodType</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">new_cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">exc_handler</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_cls</span>


<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ExceptionMeta</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Calc</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<span class="k">class</span> <span class="nc">CalcAdv</span><span class="p">(</span><span class="n">Calc</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>


<span class="n">mycal</span> <span class="o">=</span> <span class="n">CalcAdv</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">mycal</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Exception Occured!
Method name: CalcAdv.div
Args: (&lt;__main__.CalcAdv object at 0x7febe692d1c0&gt;, 2, 0), Kwargs: {}



---------------------------------------------------------------------------

ZeroDivisionError                         Traceback (most recent call last)

&lt;ipython-input-467-accaebe919a8&gt; in &lt;module&gt;
        43
        44 mycal = CalcAdv()
---&gt; 45 print(mycal.div(2, 0))

...

ZeroDivisionError: division by zero
</code></pre></div></div>

<h3 id="abstract-base-classes">
<a class="anchor" href="#abstract-base-classes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Abstract Base Classes</h3>

<p>An abstract class can be regarded as a blueprint for other classes. It allows you to provide a set of methods that must be implemented within any child classes built from the abstract class. Abstract classes usually house multiple abstract methods. An abstract method is a method that has a declaration but does not have an implementation. When you want to provide a common interface for different implementations of a component, abstract classes are the way to go. You can’t directly initialize or use an abstract class. Rather, you’ve to subclass the abstract base class and provide concrete implementations of all the abstract methods. Python has a dedicated <code class="highlighter-rouge">abc</code> module to help you create abstract classes. Let’s see how you can define a simple abstract class that provides four abstract methods:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>


<span class="k">class</span> <span class="nc">ICalc</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="s">"""Interface for a simple calculator."""</span>

    <span class="o">@</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="o">@</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="o">@</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">mul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="o">@</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="n">intrf</span> <span class="o">=</span> <span class="n">ICalc</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

TypeError                                 Traceback (most recent call last)

&lt;ipython-input-21-7be58e3a2a92&gt; in &lt;module&gt;
        21
        22
---&gt; 23 intrf = ICalc()


TypeError: Can't instantiate abstract class ICalc with abstract methods add, div, mul, sub
</code></pre></div></div>

<p>Although it seems like interface <code class="highlighter-rouge">ICalc</code> is simply inheriting from the class <code class="highlighter-rouge">ABC</code>, in fact, <code class="highlighter-rouge">ABC</code> is attaching a metaclass <code class="highlighter-rouge">ABCMeta</code> to <code class="highlighter-rouge">ICalc</code>. This metaclass transforms the <code class="highlighter-rouge">ICalc</code> class into an abstract class. You can see that the class <code class="highlighter-rouge">ICalc</code> gives <code class="highlighter-rouge">TypeError</code> when you take an attempt to initialize it. The only way to use this interface is via creating subclasses from <code class="highlighter-rouge">ICalc</code> base class and implementing all the abstract methods there. The snippet below shows that:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Calc</span><span class="p">(</span><span class="n">ICalc</span><span class="p">):</span>
    <span class="s">"""Concrete class that uses Icalc interface."""</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

    <span class="k">def</span> <span class="nf">sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>

    <span class="k">def</span> <span class="nf">mul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>

    <span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span>


<span class="n">calc</span> <span class="o">=</span> <span class="n">Calc</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3
-1
12
0.8
</code></pre></div></div>

<h3 id="metaclasses--dataclasses">
<a class="anchor" href="#metaclasses--dataclasses" aria-hidden="true"><span class="octicon octicon-link"></span></a>Metaclasses &amp; Dataclasses</h3>

<p>Data classes were introduced to python in version 3.7. Basically they can be regarded as code generators that reduce the amount of boilerplate you need to write while generating generic classes. Dataclasses automatically create <code class="highlighter-rouge">__init__</code>, <code class="highlighter-rouge">__repr__</code>, <code class="highlighter-rouge">__eq__</code>, <code class="highlighter-rouge">__gt__</code>, <code class="highlighter-rouge">__lt__</code> etc methods without you having to add them explicitly. This can be very handy when you need to create custom containers for your data. You can create dataclasses in the following manner:</p>

<h4 id="creating-multiple-dataclasses">
<a class="anchor" href="#creating-multiple-dataclasses" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating Multiple DataClasses</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>


<span class="o">@</span><span class="n">dataclass</span><span class="p">(</span><span class="n">unsafe_hash</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Event</span><span class="p">:</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>


<span class="o">@</span><span class="n">dataclass</span><span class="p">(</span><span class="n">unsafe_hash</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">InvoiceIssued</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="n">invoice_uuid</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">customer_uuid</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">total_amount</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">due_date</span><span class="p">:</span> <span class="n">datetime</span>


<span class="o">@</span><span class="n">dataclass</span><span class="p">(</span><span class="n">unsafe_hash</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">InvoiceOverdue</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="n">invoice_uuid</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">customer_uuid</span><span class="p">:</span> <span class="nb">int</span>


<span class="n">inv</span> <span class="o">=</span> <span class="n">InvoiceIssued</span><span class="p">(</span>
    <span class="o">**</span><span class="p">{</span>
        <span class="s">"invoice_uuid"</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
        <span class="s">"customer_uuid"</span><span class="p">:</span> <span class="mi">34</span><span class="p">,</span>
        <span class="s">"total_amount"</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="s">"due_date"</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span>
        <span class="s">"created_at"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
    <span class="p">}</span>
<span class="p">)</span>


<span class="k">print</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>InvoiceIssued(created_at=datetime.datetime(2020, 6, 20, 1, 3, 24, 967633), invoice_uuid=22, customer_uuid=34, total_amount=100.0, due_date=datetime.datetime(2020, 6, 19, 0, 0))
</code></pre></div></div>

<h4 id="avoiding-dataclass-decorator-with-metaclasses">
<a class="anchor" href="#avoiding-dataclass-decorator-with-metaclasses" aria-hidden="true"><span class="octicon octicon-link"></span></a>Avoiding Dataclass Decorator with Metaclasses</h4>

<p>Now one thing that I find cumbersome while creating multiple dataclasses is having to attach the <code class="highlighter-rouge">@dataclasses.dataclass</code> decorator to each of the dataclasses. Also, the decorator takes multiple arguments to customize the dataclass behavior and it can quickly get cumbersome when you’ve to create multiple dataclasses with custom behavior. Moreover, this goes against the DRY (Don’t Repeat Yourself) principle in software engineering.</p>

<p>To avoid this, you can write a metaclass that will automatically apply the customized dataclass decorator to all of the target classes implicitly. All you have to do is to attach the metaclass to a base dataclass and inherit from it in the later dataclasses that need to be created.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>


<span class="k">class</span> <span class="nc">EventMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="s">"""__new__ is a classmethod, even without @classmethod decorator

        Parameters
        ----------
        name : str
            name of the class being defined (Event in this example)
        bases : tuple
            base classes for constructed class, empty tuple in this case
        attrs : dict
            dict containing methods and fields defined in the class
        """</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dataclass</span><span class="p">(</span><span class="n">unsafe_hash</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)(</span><span class="n">new_cls</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">EventMeta</span><span class="p">):</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>


<span class="k">class</span> <span class="nc">InvoiceIssued</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="n">invoice_uuid</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">customer_uuid</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">total_amount</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">due_date</span><span class="p">:</span> <span class="n">datetime</span>


<span class="k">class</span> <span class="nc">InvoiceOverdue</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="n">invoice_uuid</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">customer_uuid</span><span class="p">:</span> <span class="nb">int</span>


<span class="n">inv</span> <span class="o">=</span> <span class="n">InvoiceIssued</span><span class="p">(</span>
    <span class="o">**</span><span class="p">{</span>
        <span class="s">"invoice_uuid"</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
        <span class="s">"customer_uuid"</span><span class="p">:</span> <span class="mi">34</span><span class="p">,</span>
        <span class="s">"total_amount"</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="s">"due_date"</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span>
        <span class="s">"created_at"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>InvoiceIssued(created_at=datetime.datetime(2020, 6, 24, 12, 57, 22, 543328), invoice_uuid=22, customer_uuid=34, total_amount=100.0, due_date=datetime.datetime(2020, 6, 19, 0, 0))
</code></pre></div></div>

<h2 id="should-you-use-it">
<a class="anchor" href="#should-you-use-it" aria-hidden="true"><span class="octicon octicon-link"></span></a>Should You Use It?</h2>

<p>Almost all of the problems you’ve encountered above can be solved without using metaclasses. Decorators can also be exclusively used to perform metaprogramming in a more manageable and subjectively cleaner way. One case where you absolutely have to use metaclasses is to avoid applying decorators to multiple classes or methods repetitively.</p>

<p>Also, metaclasses can easily veer into the realm of being a <em>“solution in search of a problem“.</em> If the problem at hand can be solved in a simpler way, it probably should be. However, I still think that you should at least try to understand how metaclasses work to have a better grasp on how Python classes work in general and can recognize when a metaclass really is the appropriate tool to use.</p>

<h2 id="remarks">
<a class="anchor" href="#remarks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Remarks</h2>

<p>Wrapping your mind around metaclasses can be tricky. So, to avoid any unnecessary confusion, I’ve entirely evaded any discussion regarding the behavioral difference between <em>old style classes</em> and <em>new style classes</em> in Python. Also, I’ve intentionally excluded mentioning the differences between <code class="highlighter-rouge">type</code> in Python 2 and <code class="highlighter-rouge">type</code> in Python 3 entirely. Python 2.x has reached its EOL. Save yourself some trouble and switch to Python 3.x if you already haven’t done so.</p>

<p>All the pieces of codes in the blog were written and tested with Python 3.8 on a machine running Ubuntu 18.04.</p>

<p>This article assumes familiarity with decorators, dataclasses etc. If your knowledge on them is rusty, checkout these posts on <a href="https://rednafi.github.io/digressions/python/2020/05/13/python-decorators.html">decorators</a> and <a href="https://rednafi.github.io/digressions/python/2020/03/12/python-dataclasses.html">dataclasses</a>.</p>

<h2 id="references">
<a class="anchor" href="#references" aria-hidden="true"><span class="octicon octicon-link"></span></a>References</h2>

<ul>
  <li><a href="https://blog.ionelmc.ro/2015/02/09/understanding-python-metaclasses/">Understanding Python’s Metaclasses</a></li>
  <li><a href="https://stackoverflow.com/questions/100003/what-are-metaclasses-in-python">What are metaclasses in Python - Stack Overflow</a></li>
  <li><a href="https://realpython.com/python-metaclasses/">Python Metaclasses - Real Python</a></li>
  <li><a href="https://www.geeksforgeeks.org/abstract-classes-in-python/">Metaprogramming with Metaclasses in Python - Geeksforgeeks</a></li>
  <li><a href="https://www.python-course.eu/python3_metaclasses.php">Metaclasses - Python Course EU</a></li>
  <li><a href="https://breadcrumbscollector.tech/when-to-use-metaclasses-in-python-5-interesting-use-cases/">When to Use Metaclasses in Python</a></li>
  <li><a href="https://jakevdp.github.io/blog/2012/12/01/a-primer-on-python-metaclasses/">A Primer on Python Metaclasses</a></li>
</ul>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="rednafi/digressions"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/digressions/python/2020/06/26/python-metaclasses.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/digressions/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/digressions/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/digressions/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Sporadic cogitations on software, tech &amp; personal beliefs</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/rednafi" title="rednafi"><svg class="svg-icon grey"><use xlink:href="/digressions/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/rednafi" title="rednafi"><svg class="svg-icon grey"><use xlink:href="/digressions/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
